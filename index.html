
<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Re conexão Evolution</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js" crossorigin="anonymous"></script>
  <style>
    .glass {
      backdrop-filter: saturate(180%) blur(10px);
      background: rgba(255,255,255,0.6);
    }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 text-white">
  <div class="max-w-2xl mx-auto p-6">
    <!-- Cabeçalho -->
    <header class="mb-6 flex items-center justify-between">
      <h1 class="text-2xl font-semibold">Re conexão Evolution</h1>
      <button id="shareBtn" class="px-3 py-2 rounded-xl bg-white/10 hover:bg-white/20">Compartilhar link</button>
    </header>

    <!-- Bloco único -->
    <section class="glass rounded-2xl p-6 border border-white/10 space-y-5">
      <!-- Configuração -->
      <div>
        <h2 class="text-lg font-medium mb-3">Configuração</h2>
        <div class="space-y-3 text-sm">
          <div>
            <label class="block text-white/80">API Base URL</label>
            <input id="apiBaseUrl" class="w-full mt-1 px-3 py-2 rounded-xl bg-white/10 border border-white/10 focus:outline-none" placeholder="https://seu-endpoint"/>
          </div>
          <div>
            <label class="block text-white/80">API Key</label>
            <input id="apiKey" type="password" class="w-full mt-1 px-3 py-2 rounded-xl bg-white/10 border border-white/10 focus:outline-none" placeholder="chave"/>
          </div>
          <div>
            <label class="block text-white/80">Instance Name</label>
            <input id="instanceName" class="w-full mt-1 px-3 py-2 rounded-xl bg-white/10 border border-white/10 focus:outline-none" placeholder="minha-instancia"/>
          </div>
          <div class="flex gap-2 pt-2">
            <button id="applyBtn" class="flex-1 px-3 py-2 rounded-xl bg-emerald-500 hover:bg-emerald-600">Aplicar</button>
            <button id="resetBtn" class="px-3 py-2 rounded-xl bg-white/10 hover:bg-white/20">Limpar</button>
          </div>
        </div>
      </div>

      <!-- Status -->
      <div>
        <div class="flex items-center justify-between mb-3">
          <h2 class="text-lg font-medium">Status da Instância</h2>
          <span id="statusBadge" class="text-xs px-2 py-1 rounded-full bg-yellow-500/20 border border-yellow-400/30">parado</span>
        </div>
        <div class="space-y-3 text-sm">
          <div class="flex gap-2">
            <button id="startBtn" class="flex-1 px-3 py-2 rounded-xl bg-indigo-500 hover:bg-indigo-600">Iniciar / Recarregar QR</button>
            <button id="stopBtn" class="px-3 py-2 rounded-xl bg-white/10 hover:bg-white/20">Parar</button>
          </div>
          <!-- Caixa cinza com QR -->
          <div class="rounded-xl bg-black/30 border border-white/10 p-4 mt-2 flex flex-col items-center justify-center min-h-[280px]">
            <canvas id="qrcodeCanvas" class="rounded-md"></canvas>
          </div>
        </div>
      </div>
    </section>

    <footer class="mt-6 text-center text-xs text-white/60">
      App estático – hospede no GitHub Pages, Vercel, Netlify, etc.
    </footer>
  </div>

  <!-- Scripts -->
  <script>
    const $ = s => document.querySelector(s);

    function setBadge(s) {
      const b = $("#statusBadge"),
      map = {
        conectado: "bg-emerald-500/20 border-emerald-400/30",
        aguardando_qr: "bg-yellow-500/20 border-yellow-400/30",
        parado: "bg-white/10 border-white/20",
        erro: "bg-rose-500/20 border-rose-400/30"
      };
      b.className = `text-xs px-2 py-1 rounded-full ${map[s]||map.parado}`;
      b.textContent = s.replace("_", " ");
    }

    let state = { apiBaseUrl:"", apiKey:"", instanceName:"" }, qr = null;

    function applyStateToUI() {
      $("#apiBaseUrl").value = state.apiBaseUrl || "";
      $("#apiKey").value = state.apiKey || "";
      $("#instanceName").value = state.instanceName || "";
    }

    function readUIToState() {
      state.apiBaseUrl = $("#apiBaseUrl").value.trim();
      state.apiKey = $("#apiKey").value.trim();
      state.instanceName = $("#instanceName").value.trim();
    }

    async function api(path, o={}) {
      const url = state.apiBaseUrl.replace(/\/$/,"")+path,
      h = { ...o.headers, "Content-Type":"application/json", "Authorization":`Bearer ${state.apiKey}`, "x-api-key":state.apiKey };
      const r = await fetch(url,{...o,headers:h}),t=await r.text();
      let d; try{d=JSON.parse(t)}catch{d=t}
      if(!r.ok) throw {status:r.status,data:d};
      return d;
    }

    async function ensureInstance() {
      try {
        await api(`/instances/${encodeURIComponent(state.instanceName)}`,{method:"GET"});
      } catch {
        await api("/instances",{method:"POST",body:JSON.stringify({instanceName:state.instanceName})});
      }
    }

    async function fetchQRCodeOnce() {
      const d = await api(`/instances/${encodeURIComponent(state.instanceName)}/qr`,{method:"GET"});
      const q = typeof d==="string" ? d : (d.qr||d.qrcode||JSON.stringify(d));
      if(!qr) qr = new QRious({element:document.getElementById("qrcodeCanvas"),size:240,value:q});
      else qr.value=q;
      setBadge("aguardando_qr");
    }

    async function fetchStatusOnce() {
      const d = await api(`/instances/${encodeURIComponent(state.instanceName)}/status`,{method:"GET"});
      setBadge(d?.status||"parado");
    }

    $("#applyBtn").onclick = () => { readUIToState(); applyStateToUI(); };
    $("#resetBtn").onclick = () => { state={apiBaseUrl:"",apiKey:"",instanceName:""}; applyStateToUI(); };
    $("#startBtn").onclick = async () => { readUIToState(); await ensureInstance(); await fetchQRCodeOnce(); await fetchStatusOnce(); };
    $("#stopBtn").onclick = async () => { readUIToState(); await api(`/instances/${encodeURIComponent(state.instanceName)}/stop`,{method:"POST"}); setBadge("parado"); };
    $("#shareBtn").onclick = () => { navigator.clipboard.writeText(location.href); alert("Link copiado!"); };

    applyStateToUI();
  </script>
</body>
</html>
